generator client {
  provider      = "prisma-client-js"
  engineType    = "client"
  binaryTargets = ["native", "debian-openssl-1.1.x", "linux-musl", "darwin-arm64"]
}

datasource db {
  provider = "postgresql"
}

//  ------------------------------------------------------------
//  |                     Models & Enums                       |
//  ------------------------------------------------------------

//  ----- Enums ------
/**
 * Enums are special scalar types that can be one of a predefined set of values.
 * They are useful to represent a fixed set of constants, such as roles, statuses, categories, etc.
 */

enum AuthMethod {
  PASSWORD
  SMS_OTP
  EMAIL_OTP
}

enum Role {
  CUSTOMER
  ADMIN
  VENDOR
  RIDER
}

enum DocumentType {
  CAC
  FOOD_HEALTH_CERTIFICATE
  TAX_CERTIFICATE
  FOOD_LICENSE
  ID_CARD
  OWNERSHIP_PROOF
  BANK_STATEMENT
  OTHER
}

enum PaymentSchedule {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum OnBoardingStage {
  BASIC
  DOCUMENTS
  BANK
  MENU
  CHARGES
  LIVE
}

enum BusinessType {
  RESTAURANT
  CAFE
  BAKERY
  FOOD_TRUCK
  BAR
  LOUNGE
  CATERING
  PHARMACY
  GROCERY
  FAST_FOOD
  CASUAL_DINING
  FINE_DINING
  BUFFET
  POP_UP
}

enum CuisineType {
  ITALIAN
  CHINESE
  INDIAN
  MEXICAN
  JAPANESE
  FRENCH
  THAI
  AMERICAN
  MEDITERRANEAN
  MIDDLE_EASTERN
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACKS
  DESSERT
  BEVERAGES
}

enum AvailabilityType {
  OPEN
  CLOSED
  HOLIDAY
}

enum ServiceOperation {
  DINE_IN
  TAKEAWAY
  DELIVERY
  CATERING
  PRE_ORDER
}

enum BrandType {
  INDEPENDENT
  CHAIN
  FRANCHISE
}

enum ReviewStatus {
  ONBOARDING
  PENDING
  VERIFIED
  APPROVED
  REJECTED
  SUSPENDED
  CLOSED
}

enum PriceRange {
  LOW
  MEDIUM
  HIGH
  PREMIUM
}

enum CartStatus {
  ACTIVE
  ABANDONED
  CONVERTED
}

enum FulfillmentType {
  DELIVERY
  PICKUP
  DINE_IN
}

enum FulfillmentStatus {
  PENDING
  ASSIGNED
  IN_TRANSIT
  COMPLETED
  FAILED
}

enum OrderStatus {
  CREATED
  PAID
  ACCEPTED
  PREPARING
  READY
  DELIVERING
  COMPLETED
  CANCELLED
}

enum VendorRole {
  ADMIN
  MANAGER
  OWNER
  STAFF
}

enum RiderDocumentType {
  ID_CARD
  DRIVER_LICENSE
  VEHICLE_INSURANCE
  ROAD_WORTHINESS
}

enum RiderStatus {
  ONBOARDING
  VERIFIED
  ACTIVE
  SUSPENDED
  OFFLINE
}

enum VehicleType {
  BICYCLE
  MOTORCYCLE
  SCOOTER
  CAR
  VAN
  TRUCK
}

enum PromotionType {
  PERCENTAGE
  FLAT_AMOUNT
  FREE_DELIVERY
}

enum PromotionStatus {
  DRAFT
  ACTIVE
  PAUSED
  EXPIRED
}

enum PromotionTarget {
  ORDER
  ITEM
}

//  ----- Models ------
/**
 * Models are the main building blocks of your Prisma schema.
 * Each model maps to a table in your database and defines the shape of the data within that table.
 */

// Entity representing a user in the system
model User {
  id           String       @id @default(cuid())
  firstName    String
  lastName     String
  email        String       @unique
  phone        String       @unique
  authMethods  AuthMethod[]
  passwordHash String?

  isVerified Boolean   @default(false)
  verifiedAt DateTime?

  isActive  Boolean @default(true)
  isBlocked Boolean @default(false)

  blockedBy   String?
  blockReason String?
  blockedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  otp         Otp?
  customer    Customer?
  admin       Admin?
  vendor      Vendor?
  auditLogs   BusinessAuditLog[]
  carts       Cart[]
  orders      Order[]
  vendorUsers VendorUser[]
  rider       Rider?
}

// OTP model for storing one-time passwords
model Otp {
  id        String   @id @default(cuid())
  userId    String   @unique
  otpHash   String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

// Customer model representing a customer user
model Customer {
  id     String @id @default(cuid())
  userId String @unique

  firstName String?
  lastName  String?

  email     String   @unique
  phone     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user                   User                    @relation(fields: [userId], references: [id])
  customerProfile        CustomerProfile?
  customerAddresses      CustomerAddress[]
  customerPreference     CustomerPreference?
  customerLoyalty        CustomerLoyalty?
  customerPaymentMethods CustomerPaymentMethod[]
  riderReviews           RiderReview[]
  businessReviews        BusinessReview[]
  promotionRedemptions   PromotionRedemption[]
}

model CustomerProfile {
  id         String @id @default(cuid())
  customerId String @unique

  referralCode   String? @unique
  marketingOptIn Boolean @default(true)

  city       String
  state      String
  country    String
  postalCode String?

  latitude  Float?
  longitude Float?

  preferences Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id])
}

model CustomerAddress {
  id         String @id @default(cuid())
  customerId String

  label String? // Home, Work, School, etc.

  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  country      String
  postalCode   String?

  latitude  Float?
  longitude Float?

  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id])
  orders   Order[]

  @@index([customerId])
}

model CustomerPreference {
  id         String @id @default(cuid())
  customerId String @unique

  preferredPaymentMethod String?
  allowNotifications     Boolean @default(true)
  allowMarketing         Boolean @default(true)

  dietaryPreferences String[] // vegetarian, halal, etc.

  extraConfig Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id])
}

model CustomerLoyalty {
  id         String @id @default(cuid())
  customerId String @unique

  points        Int   @default(0)
  lifetimeSpend Float @default(0)

  tier String? // bronze, silver, gold

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id])
}

model CustomerPaymentMethod {
  id         String @id @default(cuid())
  customerId String

  provider  String // paystack, stripe, flutterwave
  reference String // token from provider
  last4     String?
  brand     String? // visa, mastercard

  isDefault Boolean @default(false)

  createdAt DateTime @default(now())

  customer Customer @relation(fields: [customerId], references: [id])

  @@index([customerId])
}

// Admin model representing an admin user
model Admin {
  id        String   @id @default(cuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model Rider {
  id     String @id @default(cuid())
  userId String @unique

  status   RiderStatus @default(ONBOARDING)
  isActive Boolean     @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User            @relation(fields: [userId], references: [id])
  vehicle      RiderVehicle[]
  documents    RiderDocument[]
  fulfillments Fulfillment[]
  riderReviews RiderReview[]
}

model RiderDocument {
  id      String @id @default(cuid())
  riderId String

  type            RiderDocumentType
  fileUrl         String
  status          ReviewStatus      @default(PENDING)
  rejectionReason String?

  issuedAt  DateTime?
  expiresAr DateTime?

  createdAt DateTime @default(now())

  rider Rider @relation(fields: [riderId], references: [id])
}

model RiderVehicle {
  id      String @id @default(cuid())
  riderId String

  vehicleType   VehicleType
  make          String
  model         String
  year          Int
  plateNumber   String      @unique
  color         String
  insuranceInfo String?
  isActive      Boolean     @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rider Rider @relation(fields: [riderId], references: [id])
}

model RiderReview {
  id         String @id @default(cuid())
  riderId    String
  customerId String
  orderId    String @unique

  rating  Int // 1–5
  comment String?

  wasPolite      Boolean?
  deliveryOnTime Boolean?

  isVisible Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rider    Rider    @relation(fields: [riderId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])
  order    Order    @relation(fields: [orderId], references: [id])

  @@index([riderId])
  @@index([customerId])
}

model Vendor {
  id     String @id @default(cuid())
  userId String @unique

  legalName    String
  displayName  String
  supportEmail String @unique
  supportPhone String @unique
  address      String

  status          ReviewStatus    @default(ONBOARDING)
  onBoardingStage OnBoardingStage @default(BASIC)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user        User             @relation(fields: [userId], references: [id])
  businesses  Business[]
  financials  VendorFinancial?
  documents   VendorDocument[]
  vendorUsers VendorUser[]
}

model VendorDocument {
  id       String @id @default(cuid())
  vendorId String

  type            DocumentType
  fileUrl         String
  status          ReviewStatus
  rejectionReason String?

  createdAt DateTime @default(now())

  vendor Vendor @relation(fields: [vendorId], references: [id])
}

model VendorFinancial {
  id       String @id @default(cuid())
  vendorId String @unique

  bankName      String
  accountNumber String
  accountName   String

  paymentSchedule PaymentSchedule @default(WEEKLY)
  commissionRate  Float           @default(0.0)

  walletBalance Float @default(0.0)
  pendingPayout Float @default(0.0)
  paidToDate    Float @default(0.0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vendor Vendor @relation(fields: [vendorId], references: [id])
}

model Permission {
  id          String  @id @default(cuid())
  key         String  @unique
  description String?

  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  vendorRolePermissions VendorRolePermission[]
}

model VendorRolePermission {
  id           String     @id @default(cuid())
  role         VendorRole
  permissionId String

  permission Permission @relation(fields: [permissionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([role, permissionId])
}

model VendorUser {
  id       String     @id @default(cuid())
  vendorId String
  userId   String
  role     VendorRole

  isActive Boolean @default(true)

  vendor Vendor @relation(fields: [vendorId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([vendorId, userId])
}

model Business {
  id          String  @id @default(cuid())
  vendorId    String
  legalName   String
  displayName String?
  slug        String  @unique

  email         String   @unique
  phone         String   @unique
  establishedAt DateTime
  description   String

  businessType      BusinessType
  brandType         BrandType
  serviceOperations ServiceOperation[]

  registrationNumber String @unique
  taxId              String @unique

  status          ReviewStatus
  onBoardingStage OnBoardingStage @default(BASIC)

  isActive   Boolean @default(false)
  isFeatured Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vendor             Vendor                 @relation(fields: [vendorId], references: [id])
  profile            BusinessProfile?
  locations          BusinessLocation[]
  availabilities     BusinessAvailability[]
  businessSettings   BusinessSetting[]
  businessCharges    BusinessCharge[]
  businessAuditLogs  BusinessAuditLog[]
  documents          BusinessDocument[]
  offerings          BusinessOffering[]
  menuCategories     MenuCategory[]
  menuItems          MenuItem[]
  carts              Cart[]
  orders             Order[]
  businessReviews    BusinessReview[]
  businessPromotions BusinessPromotion[]
}

model BusinessOffering {
  id         String @id @default(cuid())
  businessId String

  type BusinessType

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id])
}

model BusinessProfile {
  id         String @id @default(cuid())
  businessId String @unique

  logoUrl       String?
  coverImageUrl String?
  gallery       String[]

  primaryPhone   String
  secondaryPhone String?
  supportEmail   String

  websiteUrl   String?
  instagramUrl String?
  facebookUrl  String?
  twitterUrl   String?

  address    String
  city       String
  state      String
  country    String
  postalCode String?
  lga        String?
  streetName String

  averagePrepTime Int        @default(30) // in minutes
  priceRange      PriceRange @default(MEDIUM)

  rating    Float @default(0.0)
  rateCount Int   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id])
}

model BusinessLocation {
  id         String @id @default(cuid())
  businessId String

  name         String
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  country      String
  postalCode   String?

  latitude  Float
  longitude Float

  deliveryRadius Int @default(5) // in kilometers

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business      Business               @relation(fields: [businessId], references: [id])
  locationHours BusinessAvailability[]
  orders        Order[]
}

model BusinessAvailability {
  id         String @id @default(cuid())
  businessId String
  locationId String

  dayOfWeek Int

  availabilityType AvailabilityType
  openingTime      DateTime
  closingTime      DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business Business         @relation(fields: [businessId], references: [id])
  location BusinessLocation @relation(fields: [locationId], references: [id])
}

model BusinessDocument {
  id         String @id @default(cuid())
  businessId String

  documentType    DocumentType
  documentUrl     String
  status          ReviewStatus
  rejectionReason String?

  createdAt DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id])
}

model BusinessCharge {
  id         String @id @default(cuid())
  businessId String

  deliveryFee       Float @default(0.0)
  serviceChargeRate Float @default(0.0)
  taxRate           Float @default(0.0)

  updatedAt DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id])
}

model BusinessReview {
  id         String @id @default(cuid())
  businessId String
  customerId String
  orderId    String @unique

  rating  Int // 1–5
  comment String?

  isAnonymous Boolean @default(false)
  isVisible   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])
  order    Order    @relation(fields: [orderId], references: [id])

  @@index([businessId])
  @@index([customerId])
}

model BusinessSetting {
  id         String @id @default(cuid())
  businessId String

  enableOnlineOrdering Boolean @default(true)
  enableReservations   Boolean @default(false)
  enableReviews        Boolean @default(true)
  autoAcceptOrders     Boolean @default(false)
  allowPreOrders       Boolean @default(true)
  maxOrderPerDay       Int     @default(100)

  preparationTime Int @default(30) // in minutes

  extraConfig Json?

  updatedAt DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id])
}

model BusinessAuditLog {
  id           String @id @default(cuid())
  businessId   String
  ownerId      String
  changeType   String
  changeDetail String

  metaData  Json?
  createdAt DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id])
  owner    User     @relation(fields: [ownerId], references: [id])
}

model MenuCategory {
  id         String @id @default(cuid())
  businessId String

  name        String
  description String?

  order    Int     @default(0)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business Business   @relation(fields: [businessId], references: [id])
  items    MenuItem[]
}

model MenuItem {
  id         String @id @default(cuid())
  businessId String
  categoryId String

  name        String
  description String?
  imageUrl    String?

  basePrice    Float
  sellingPrice Float
  specialPrice Float?
  isFeatured   Boolean @default(false)
  isAvailable  Boolean @default(true)
  isSoldOut    Boolean @default(false)

  quantityInStock Int @default(0)

  variants MenuVariant[]
  addons   MenuAddon[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  category           MenuCategory        @relation(fields: [categoryId], references: [id])
  business           Business            @relation(fields: [businessId], references: [id])
  items              CartItem[]
  promotionMenuItems PromotionMenuItem[]
}

model MenuVariant {
  id         String @id @default(cuid())
  menuItemId String

  name        String
  description String?
  price       Float   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  menuItem MenuItem @relation(fields: [menuItemId], references: [id])
}

model MenuAddon {
  id         String @id @default(cuid())
  menuItemId String

  name        String
  description String?
  price       Float

  isAvailable Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  menuItem MenuItem @relation(fields: [menuItemId], references: [id])
}

model Cart {
  id         String @id @default(cuid())
  userId     String
  businessId String

  status CartStatus @default(ACTIVE)

  items CartItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User     @relation(fields: [userId], references: [id])
  business Business @relation(fields: [businessId], references: [id])
}

model CartItem {
  id         String @id @default(cuid())
  cartId     String
  menuItemId String

  quantity  Int   @default(1)
  unitPrice Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cart     Cart     @relation(fields: [cartId], references: [id])
  menuItem MenuItem @relation(fields: [menuItemId], references: [id])
}

model Order {
  id         String  @id @default(cuid())
  userId     String
  businessId String
  locationId String?

  customerAddressId String?

  status      OrderStatus
  totalAmount Float
  paymentRef  String?

  discountAmount Float   @default(0)
  promotionCode  String?
  promotionId    String?

  user            User               @relation(fields: [userId], references: [id])
  business        Business           @relation(fields: [businessId], references: [id])
  location        BusinessLocation?  @relation(fields: [locationId], references: [id])
  deliveryAddress CustomerAddress?   @relation(fields: [customerAddressId], references: [id])
  promotion       BusinessPromotion? @relation(fields: [promotionId], references: [id])

  fulfillments Fulfillment[]
  items        OrderItem[]
  timeline     OrderTimeline[]

  createdAt            DateTime              @default(now())
  riderReview          RiderReview?
  businessReview       BusinessReview?
  promotionRedemptions PromotionRedemption[]
}

model OrderItem {
  id      String @id @default(cuid())
  orderId String

  name      String
  quantity  Int
  unitPrice Float
  total     Float

  order Order @relation(fields: [orderId], references: [id])
}

model OrderTimeline {
  id      String      @id @default(cuid())
  orderId String
  status  OrderStatus
  note    String?

  order Order @relation(fields: [orderId], references: [id])

  createdAt DateTime @default(now())
}

model Fulfillment {
  id      String          @id @default(cuid())
  orderId String
  type    FulfillmentType

  riderId String?
  status  FulfillmentStatus

  pickupAddress  String?
  dropoffAddress String?

  order Order  @relation(fields: [orderId], references: [id])
  rider Rider? @relation(fields: [riderId], references: [id])

  createdAt DateTime @default(now())
}

model BusinessPromotion {
  id         String @id @default(cuid())
  businessId String

  name        String
  description String?

  code String? @unique // nullable = auto-applied promo

  type   PromotionType
  target PromotionTarget @default(ORDER)

  value Float // % or flat amount depending on type

  status PromotionStatus @default(DRAFT)

  startsAt DateTime
  endsAt   DateTime

  maxRedemptions        Int?
  maxRedemptionsPerUser Int?

  isStackable Boolean @default(false)
  isAutoApply Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id])

  conditions  PromotionCondition[]
  redemptions PromotionRedemption[]
  menuItems   PromotionMenuItem[]
  orders      Order[]

  @@index([businessId])
}

model PromotionCondition {
  id          String @id @default(cuid())
  promotionId String

  minOrderAmount Float?
  maxOrderAmount Float?

  minItemQuantity    Int?
  customerFirstOrder Boolean?

  createdAt DateTime @default(now())

  promotion BusinessPromotion @relation(fields: [promotionId], references: [id])

  @@index([promotionId])
}

model PromotionMenuItem {
  id          String @id @default(cuid())
  promotionId String
  menuItemId  String

  promotion BusinessPromotion @relation(fields: [promotionId], references: [id])
  menuItem  MenuItem          @relation(fields: [menuItemId], references: [id])

  @@unique([promotionId, menuItemId])
}

model PromotionRedemption {
  id          String @id @default(cuid())
  promotionId String
  customerId  String
  orderId     String

  redeemedAt DateTime @default(now())

  promotion BusinessPromotion @relation(fields: [promotionId], references: [id])
  customer  Customer          @relation(fields: [customerId], references: [id])
  order     Order             @relation(fields: [orderId], references: [id])

  @@unique([promotionId, orderId])
  @@index([customerId])
}
